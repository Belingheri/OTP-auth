<!DOCTYPE html>
<html lang="en">
  <head>
    <title>2FA Controlla Codice</title>

    <meta charset="utf-8" />
    <meta name="description" content="2FA QR code generator" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css"
    />

    <style>
      html {
        overflow-y: auto;
      }
      .pointer {
        cursor: pointer;
      }
    </style>

    <script src="./js/bulma.js"></script>

    <script src="./js/jsOTP.js"></script>
  </head>
  <body>
    <nav class="navbar is-black" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" href="#"> OTP-Auth </a>

        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarBasicExample"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
          <a class="navbar-item" href="./configQr.html"> 2FA Genera QR </a>

          <a class="navbar-item" href="./generaCodice.html">
            Controllo Codice
          </a>
        </div>
        <div class="navbar-end">
          <div class="navbar-item">
            <div class="field is-grouped">
              <p class="control">
                <a
                  class="button is-link is-light"
                  href="https://github.com/Belingheri/OTP-auth"
                >
                  <span class="icon">
                    <img src="./img/githubLogo.png" alt="githubLogo" />
                  </span>
                  <span>GitHub</span>
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container is-fluid">
      <div class="columns">
        <div class="column is-4">
          <h2 class="subtitle is-2">OTP Salvati</h2>
          <small>
            Gli OTP mostrati e savati sono solo quelli su questo PC ed in questo
            browserüîè, non avviene nessun tipo di salvataggio online, il
            programma tiene <b>tutti</b> i dati ed effettua i calcoli localmente
            üòé
          </small>
          <div id="listaSalvati"></div>
        </div>
        <div class="column">
          <h2 class="title is-2">Generazione Codice</h2>
          <h3 class="subtitle is-3">Seleziona un elemento dalla lista</h3>
          <small>La generazione del codice avvine localmente!</small>
          <label id="id" class="label"></label>
          <div class="field has-addons">
            <p class="control">
              <a class="button is-static" id="countDown"> CountDown s </a>
            </p>
            <p class="control">
              <input
                id="otpcode"
                type="text"
                class="input"
                aria-label="Default"
                readonly
              />
            </p>
          </div>

          <h2 class="title is-2">Verifica codice</h2>
          <h3 class="subtitle is-3">
            Inserisci il codice generato dall'aplicazione
          </h3>
          <div class="field">
            <label class="label is-small"
              >Si, corrisposnde a quello generato sopra</label
            >
            <div class="field has-addons">
              <p class="control">
                <input class="input" type="text" id="verificaCodcie" />
              </p>
              <p class="control">
                <button class="button is-primary" id="verificaCodiceFtn">
                  Verifica
                </button>
              </p>
            </div>
            <span id="esito"></span>
          </div>
        </div>
      </div>
    </div>
    <script type="module">
      import { stampaListaOTPSalvati, getOTPById } from "./js/generaCodice.js";

      var interval;
      function OTPSelezionato(obj) {
        if (interval) clearInterval(interval);
        if (obj.type !== "totp")
          return alert("OTP counter non ancora implementato");
        document.getElementById("id").innerHTML = obj.id;
        riempiOTPForm(obj);
        interval = setInterval(() => {
          riempiOTPForm(obj);
        }, 500);
      }
      function riempiOTPForm(obj) {
        const totp = new jsOTP.totp();
        const timeCode = totp.getOtp(obj.secret);
        const prettyTimeCode =
          timeCode.substring(0, 3) + " " + timeCode.substring(3);
        const epoch = Math.round(new Date().getTime() / 1000.0);
        const countDown = 30 - (epoch % 30);
        document.getElementById("countDown").innerHTML = `${countDown} sec`;

        const otpCodeEl = document.getElementById("otpcode");
        if (otpCodeEl.value !== prettyTimeCode)
          otpCodeEl.value = prettyTimeCode;
      }

      function verificaCodice() {
        const idOTP = document.getElementById("id").innerHTML;
        if (!idOTP)
          return alert("Seleziona un elemento dalla lista a sinistra");

        const obj = getOTPById(idOTP);
        if (obj.type !== "totp")
          return alert("OTP counter non ancora implementato");

        const codiceVero = new jsOTP.totp().getOtp(obj.secret);
        const codcieUtenteEl = document.getElementById("verificaCodcie");
        const codcieUtente = codcieUtenteEl.value.replaceAll(" ", "");
        codcieUtenteEl.value = "";

        if (codcieUtente === codiceVero)
          document.getElementById("esito").innerHTML = "Codice Corretto üòäüéâ";
        else
          document.getElementById(
            "esito"
          ).innerHTML = `Codice inserito <i>${codcieUtente}</i> Scaduto ‚åö o Errato ü§¨`;
      }

      stampaListaOTPSalvati("listaSalvati", OTPSelezionato);
      document
        .getElementById("verificaCodiceFtn")
        .addEventListener("click", verificaCodice);
    </script>
    <footer class="footer">
      <div class="content has-text-centered">
        <p>
          <strong>OTP-Auth</strong> by
          <a href="https://about.me/belingheri" target="_blank">Belingheri</a>.
          The source code is on
          <a href="https://github.com/Belingheri/OTP-auth" target="_blank"
            >GitHub</a
          >.
        </p>
      </div>
    </footer>
  </body>
</html>
