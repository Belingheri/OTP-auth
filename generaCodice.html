<!DOCTYPE html>
<html lang="en">
  <head>
    <title>2FA Controlla Codice</title>

    <meta charset="utf-8" />
    <meta name="description" content="2FA QR code generator" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/gh/lrsjng/jquery-qrcode@v0.18.0/dist/jquery-qrcode.min.js"
      integrity="sha384-W+CodFEp2EiGOM49HsUJwCpf58Vkgsx5CtgCl6bQJiAfGb+ndvp/fE8dZtI9fnUD"
      crossorigin="anonymous"
    ></script>

    <script src="./js/jsOTP.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="./index.html">OTP</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarText"
        aria-controls="navbarText"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarText">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="./configQr.html">2FA Genera QR</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="#"
              >Controllo Codice<span class="sr-only">(current)</span></a
            >
          </li>
        </ul>
        <span class="navbar-text">Beta</span>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-4">
          <h2>OTP Salvati</h2>
          <small>
            Gli OTP mostrati e savati sono solo quelli su questo PC ed in questo
            browserüîè, non avviene nessun tipo di salvataggio online, il
            programma tiene <b>tutti</b> i dati ed effettua i calcoli localmente
            üòé
          </small>
          <ol id="listaSalvati" class="list-group"></ol>
        </div>
        <div class="col-lg">
          <h2>Generazione Codice</h2>
          <h3>Seleziona un elemento dalla lista</h3>
          <small>La generazione del codice avvine localmente!</small>
          <input class="form-control" type="text" id="id" readonly />

          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="countDown">CountDown s</span>
            </div>
            <input
              id="otpcode"
              type="text"
              class="form-control"
              aria-label="Default"
              readonly
            />
          </div>

          <h2>Verifica codice</h2>
          <h3>Inserisci il codice generato dall'aplicazione</h3>
          <small>si corrisposnde a quello generato sopra</small>
          <input class="form-control" type="text" id="verificaCodcie" />
          <button class="btn btn-primary" id="verificaCodiceFtn">
            Verifica
          </button>
          <span id="esito"></span>
        </div>
      </div>
    </div>
    <script type="module">
      import { stampaListaOTPSalvati, getOTPById } from "./js/generaCodice.js";

      var interval;
      function OTPSelezionato(obj) {
        if (interval) clearInterval(interval);
        if (obj.type !== "totp")
          return alert("OTP counter non ancora implementato");
        document.getElementById("id").value = obj.id;
        riempiOTPForm(obj);
        setInterval(() => {
          riempiOTPForm(obj);
        }, 500);
      }
      function riempiOTPForm(obj) {
        const totp = new jsOTP.totp();
        const timeCode = totp.getOtp(obj.secret);
        const prettyTimeCode =
          timeCode.substring(0, 3) + " " + timeCode.substring(3);
        const epoch = Math.round(new Date().getTime() / 1000.0);
        const countDown = 30 - (epoch % 30);
        document.getElementById("countDown").innerHTML = `${countDown} sec`;
        document.getElementById("otpcode").value = prettyTimeCode;
      }

      function verificaCodice() {
        const idOTP = document.getElementById("id").value;
        if (!idOTP)
          return alert("Seleziona un elemento dalla lista a sinistra");

        const obj = getOTPById(idOTP);
        if (obj.type !== "totp")
          return alert("OTP counter non ancora implementato");

        const codiceVero = new jsOTP.totp().getOtp(obj.secret);
        const codcieUtenteEl = document.getElementById("verificaCodcie");
        const codcieUtente = codcieUtenteEl.value.replaceAll(" ", "");
        codcieUtenteEl.value = "";

        if (codcieUtente === codiceVero)
          document.getElementById("esito").innerHTML = "Codice Corretto üòäüéâ";
        else
          document.getElementById(
            "esito"
          ).innerHTML = `Codice inserito <i>${codcieUtente}</i> Scaduto ‚åö o Errato ü§¨`;
      }

      stampaListaOTPSalvati("listaSalvati", OTPSelezionato);
      document
        .getElementById("verificaCodiceFtn")
        .addEventListener("click", verificaCodice);
    </script>
  </body>
</html>
